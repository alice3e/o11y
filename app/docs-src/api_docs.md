<!-- omit in toc -->
# API Documentation

- [Обзор API](#обзор-api)
- [Единый Swagger UI](#единый-swagger-ui)
  - [Возможности Swagger UI](#возможности-swagger-ui)
  - [Автоматическая аутентификация](#автоматическая-аутентификация)
  - [Смена пользователя](#смена-пользователя)
- [Backend API](#backend-api)
  - [Endpoints](#endpoints)
    - [Products](#products)
    - [System](#system)
- [Cart API](#cart-api)
  - [Endpoints](#endpoints-1)
- [Order API](#order-api)
  - [Endpoints](#endpoints-2)
- [User API](#user-api)
  - [Endpoints](#endpoints-3)
- [Аутентификация](#аутентификация)
  - [Получение токена](#получение-токена)
  - [Использование токена](#использование-токена)
  - [Тестирование аутентификации](#тестирование-аутентификации)
- [Административные функции](#административные-функции)
- [Коды ответов](#коды-ответов)

## Обзор API

API нашей системы разделен на несколько микросервисов, каждый из которых отвечает за определенную функциональность:

- **Backend API** (`/api/*`) - основной API для работы с данными о товарах и категориях
- **Cart API** (`/cart-api/*`) - API для работы с корзиной
- **Order API** (`/order-api/*`) - API для работы с заказами
- **User API** (`/user-api/*`) - API для работы с пользователями

Все микросервисы доступны через единую точку входа по базовому URL: `http://localhost/`.

## Единый Swagger UI

Для удобства работы с API всех микросервисов, мы предоставляем единый Swagger UI, который объединяет документацию по всем API эндпоинтам в одном интерфейсе.

**Swagger UI доступен по адресу: [http://localhost/swagger/](http://localhost/swagger/)**

### Возможности Swagger UI

- **Объединенная документация** - все API эндпоинты из всех микросервисов в одном интерфейсе
- **Интерактивное тестирование** - возможность выполнять запросы прямо из интерфейса
- **Аутентификация** - поддержка JWT-токенов для тестирования защищенных эндпоинтов
- **Административный режим** - возможность тестировать эндпоинты, требующие административных прав
- **Фильтрация и поиск** - удобный поиск по эндпоинтам и тегам

### Автоматическая аутентификация

Для удобства тестирования API, при открытии Swagger UI **автоматически выполняется вход** под пользователем **swagger_admin** с правами администратора. Это позволяет сразу же тестировать все эндпоинты, включая те, которые требуют аутентификации или административных прав.

**Учетные данные по умолчанию:**
- **swagger_admin**: пользователь с административными правами (пароль: admin123)
- **swagger_user**: обычный пользователь (пароль: password123)

Эти пользователи создаются автоматически при запуске сервиса пользователей, а их учетные данные выводятся в логи контейнера.

### Смена пользователя

Если вам нужно протестировать API от имени другого пользователя:

1. **Получение нового токена**:
   - Используйте эндпоинт `POST /user-api/token` с нужными учетными данными
   - Скопируйте полученный токен из поля `access_token` в ответе

2. **Смена токена**:
   - Вставьте новый токен в поле "JWT Token" в верхней части страницы Swagger UI
   - Нажмите кнопку "Authorize"

3. **Настройка прав**:
   - Если вы входите как обычный пользователь, снимите флажок "Admin Mode"
   - Если вы входите как администратор, установите флажок "Admin Mode"

## Backend API

### Endpoints

#### Products

| Метод | Эндпоинт | Описание |
| ----- | -------- | -------- |
| GET | `/api/products/list` | Получение списка всех товаров с пагинацией |
| GET | `/api/products/{product_id}` | Получение информации о конкретном товаре |
| GET | `/api/products/categories/list` | Получение списка категорий товаров |
| GET | `/api/products/by-category/{category}` | Получение товаров определенной категории с пагинацией |
| POST | `/api/products/` | Создание нового товара |
| PUT | `/api/products/{product_id}` | Обновление информации о товаре |
| DELETE | `/api/products/{product_id}` | Удаление товара |

#### System

| Метод | Эндпоинт | Описание |
| ----- | -------- | -------- |
| GET | `/api/system/health` | Проверка работоспособности системы |

## Cart API

### Endpoints

| Метод | Эндпоинт | Описание |
| ----- | -------- | -------- |
| GET | `/cart-api/cart/` | Получение корзины пользователя |
| POST | `/cart-api/cart/items` | Добавление товара в корзину |
| PUT | `/cart-api/cart/items/{item_id}` | Обновление количества товара в корзине |
| DELETE | `/cart-api/cart/items/{item_id}` | Удаление товара из корзины |
| GET | `/cart-api/cart/total` | Получение общей стоимости корзины |
| POST | `/cart-api/cart/checkout` | Оформление заказа из корзины |
| DELETE | `/cart-api/cart/` | Очистка корзины |
| GET | `/cart-api/categories/` | Получение списка категорий товаров |
| GET | `/cart-api/products/category/{category}` | Получение товаров по категории с фильтрацией и сортировкой |
| POST | `/cart-api/products/{product_id}/view` | Запись о просмотре товара пользователем |
| GET | `/cart-api/products/recent-views` | Получение списка недавно просмотренных товаров |
| GET | `/cart-api/products/recommendations` | Получение рекомендаций на основе просмотренных товаров |

## Order API

### Endpoints

| Метод | Эндпоинт | Описание |
| ----- | -------- | -------- |
| GET | `/order-api/orders/` | Получение списка заказов пользователя |
| POST | `/order-api/orders/` | Создание нового заказа |
| GET | `/order-api/orders/{order_id}` | Получение информации о заказе |
| PUT | `/order-api/orders/{order_id}/status` | Обновление статуса заказа (только для администраторов) |
| PUT | `/order-api/orders/{order_id}/cancel` | Отмена заказа |
| GET | `/order-api/orders/statuses/list` | Получение списка возможных статусов заказа |

## User API

### Endpoints

| Метод | Эндпоинт | Описание |
| ----- | -------- | -------- |
| POST | `/user-api/users/register` | Регистрация нового пользователя |
| POST | `/user-api/token` | Аутентификация пользователя и получение токена |
| GET | `/user-api/users/me` | Получение информации о текущем пользователе |
| PUT | `/user-api/users/me` | Обновление информации о пользователе |
| GET | `/user-api/users/me/profile` | Получение профиля пользователя с информацией о заказах и корзине |
| GET | `/user-api/users/me/orders` | Получение списка заказов пользователя |
| GET | `/user-api/users/me/cart` | Получение корзины пользователя |
| POST | `/user-api/users/me/orders` | Оформление заказа из корзины пользователя |
| GET | `/user-api/users/me/total-spent` | Получение общей суммы потраченных средств |
| GET | `/user-api/swagger-admin-token` | Получение токена администратора для Swagger UI |

## Аутентификация

### Получение токена

Для доступа к защищенным эндпоинтам требуется JWT-токен. Получить токен можно двумя способами:

**1. Через Swagger UI:**
- Перейдите в [Swagger UI](http://localhost/swagger/)
- Найдите эндпоинт `POST /user-api/token`
- Введите имя пользователя и пароль (например, swagger_user / password123)
- Выполните запрос и скопируйте полученный токен

**2. С помощью curl:**

```bash
curl -X POST http://localhost/user-api/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=swagger_user&password=password123"
```

Ответ будет содержать JWT-токен:

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR...",
  "token_type": "bearer"
}
```

### Использование токена

Полученный токен необходимо передавать в заголовке `Authorization` в формате `Bearer <token>` для всех защищенных запросов.

Пример запроса с использованием токена:

```bash
curl -X GET http://localhost/user-api/users/me \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR..."
```

### Тестирование аутентификации

Для быстрого тестирования всего процесса аутентификации и взаимодействия между сервисами можно использовать скрипт `test_all_microservices.sh`:

```bash
./test_all_microservices.sh
```

Этот скрипт демонстрирует полный процесс регистрации, получения токена и его использования для доступа к защищенным ресурсам.

## Административные функции

Некоторые эндпоинты доступны только пользователям с административными правами. Для доступа к таким эндпоинтам необходимо передавать заголовок `admin: true` в запросе.

В Swagger UI вы можете включить или отключить административный режим, установив или сняв флажок "Admin Mode" в верхней части страницы. По умолчанию административный режим включен, так как вход выполняется под пользователем swagger_admin.

Пример запроса с административными правами:

```bash
curl -X GET http://localhost/order-api/orders/ \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR..." \
  -H "admin: true"
```

## Коды ответов

| Код | Описание |
| --- | -------- |
| 200 | Успешно |
| 201 | Создано |
| 400 | Неверный запрос |
| 401 | Неавторизованный доступ |
| 403 | Доступ запрещен |
| 404 | Не найдено |
| 500 | Внутренняя ошибка сервера |

