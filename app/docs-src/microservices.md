# Микросервисы

Проект реализован в виде микросервисной архитектуры, где каждый сервис отвечает за свою область функциональности и может быть разработан, развернут и масштабирован независимо.

## Общая схема взаимодействия

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    Nginx    │     │    Docs     │     │  Cassandra  │     │ Load Tester │
└──────┬──────┘     └─────────────┘     └──────┬──────┘     └─────────────┘
       │                                       │
       │                                       │
       │                                       │
       │                                       │
       │                                       ▼
       │                              ┌─────────────────┐
       ├─────────────────────────────▶│  Backend API   │
       │                              └────────┬────────┘
       │                                       │
       │                                       │
       │                                       │
       │                                       │
       │                                       │
       │      ┌────────────────────────────────┼────────────────────────┐
       │      │                                │                        │
       │      │                                │                        │
       │      ▼                                ▼                        ▼
       │┌─────────────┐                 ┌─────────────┐          ┌─────────────┐
       ├┤ User Service│◀───────────────▶│ Cart Service│◀────────▶│Order Service│
       │└─────────────┘                 └─────────────┘          └─────────────┘
       │
       │
       ▼
┌─────────────┐
│   Клиент    │
└─────────────┘
```

## Backend Service

Основной сервис для работы с товарами и базой данных Cassandra.

### Технические характеристики

- **Язык программирования**: Python 3.11
- **Фреймворк**: FastAPI
- **База данных**: Cassandra
- **Порт**: 8000
- **Контейнер**: app/backend/Dockerfile

### Основные компоненты

1. **API модуль** (`app/backend/src/api/`):
   - `products.py` - API для работы с товарами
   - `system.py` - API для проверки состояния системы

2. **Core модуль** (`app/backend/src/core/`):
   - `models.py` - Модели данных (Pydantic)

3. **Services модуль** (`app/backend/src/services/`):
   - `cassandra.py` - Сервис для работы с базой данных Cassandra

### Основные эндпоинты

- `GET /api/system/health` - Проверка состояния сервиса и подключения к БД
- `GET /api/products/` - Получение списка всех товаров
- `POST /api/products/` - Создание нового товара
- `GET /api/products/{product_id}` - Получение информации о конкретном товаре
- `PUT /api/products/{product_id}` - Обновление информации о товаре
- `DELETE /api/products/{product_id}` - Удаление товара

### Зависимости

- `fastapi` - Веб-фреймворк для создания API
- `uvicorn` - ASGI-сервер для запуска FastAPI
- `cassandra-driver` - Драйвер для работы с Cassandra

### Взаимодействие с другими сервисами

- **Cart Service** - Получает информацию о товарах
- **Order Service** - Получает информацию о товарах

## User Service

Сервис для управления пользователями, их аутентификацией и профилями.

### Технические характеристики

- **Язык программирования**: Python 3.11
- **Фреймворк**: FastAPI
- **Хранилище данных**: In-memory (в реальном приложении - база данных)
- **Порт**: 8003
- **Контейнер**: app/user-service/Dockerfile

### Основные компоненты

1. **Модели данных**:
   - `UserBase` - Базовая модель пользователя
   - `UserCreate` - Модель для создания пользователя
   - `User` - Полная модель пользователя
   - `UserInDB` - Модель пользователя в базе данных (с хешированным паролем)
   - `Token` - Модель токена доступа
   - `UserProfile` - Расширенная модель профиля пользователя

2. **Аутентификация**:
   - JWT-токены для аутентификации
   - Хеширование паролей с использованием bcrypt
   - OAuth2 с Password Flow

### Основные эндпоинты

- `POST /user-api/users/register` - Регистрация нового пользователя
- `POST /user-api/token` - Аутентификация пользователя и получение токена
- `GET /user-api/users/me` - Получение информации о текущем пользователе
- `GET /user-api/users/me/profile` - Получение профиля пользователя с информацией о заказах и корзине
- `PUT /user-api/users/me` - Обновление информации о пользователе
- `GET /user-api/users/me/orders` - Получение списка заказов пользователя
- `GET /user-api/users/me/cart` - Получение корзины пользователя
- `POST /user-api/users/me/orders` - Оформление заказа из корзины пользователя
- `GET /user-api/users/me/total-spent` - Получение общей суммы потраченных средств

### Зависимости

- `fastapi` - Веб-фреймворк для создания API
- `uvicorn` - ASGI-сервер для запуска FastAPI
- `httpx` - HTTP-клиент для асинхронных запросов
- `pydantic` - Валидация данных
- `python-multipart` - Обработка form-data запросов
- `python-jose[cryptography]` - Работа с JWT-токенами
- `passlib[bcrypt]` - Хеширование паролей

### Взаимодействие с другими сервисами

- **Cart Service** - Получение информации о корзине пользователя
- **Order Service** - Получение информации о заказах пользователя

## Cart Service

Сервис для управления корзиной пользователя.

### Технические характеристики

- **Язык программирования**: Python 3.11
- **Фреймворк**: FastAPI
- **Хранилище данных**: In-memory (в реальном приложении - Redis или другая БД)
- **Порт**: 8001
- **Контейнер**: app/cart-service/Dockerfile

### Основные компоненты

1. **Модели данных**:
   - `CartItem` - Элемент корзины
   - `CartItemCreate` - Модель для добавления товара в корзину
   - `CartItemUpdate` - Модель для обновления количества товара
   - `Cart` - Корзина пользователя

2. **Хранилище данных**:
   - In-memory словарь `carts_db` для хранения корзин пользователей

### Основные эндпоинты

- `GET /cart-api/cart/` - Получение текущей корзины пользователя
- `POST /cart-api/cart/items` - Добавление товара в корзину
- `PUT /cart-api/cart/items/{item_id}` - Изменение количества товара в корзине
- `DELETE /cart-api/cart/items/{item_id}` - Удаление товара из корзины
- `GET /cart-api/cart/total` - Получение общей стоимости корзины
- `POST /cart-api/cart/checkout` - Оформление заказа из корзины
- `DELETE /cart-api/cart/` - Очистка корзины
- `GET /cart-api/carts/` - Получение всех корзин (только для администраторов)

### Зависимости

- `fastapi` - Веб-фреймворк для создания API
- `uvicorn` - ASGI-сервер для запуска FastAPI
- `httpx` - HTTP-клиент для асинхронных запросов
- `pydantic` - Валидация данных

### Взаимодействие с другими сервисами

- **Backend Service** - Проверка наличия товаров и их количества
- **Order Service** - Создание заказа на основе корзины
- **User Service** - Получение информации о пользователе (через заголовки)

## Order Service

Сервис для управления заказами пользователей.

### Технические характеристики

- **Язык программирования**: Python 3.11
- **Фреймворк**: FastAPI
- **Хранилище данных**: In-memory (в реальном приложении - база данных)
- **Порт**: 8002
- **Контейнер**: app/order-service/Dockerfile

### Основные компоненты

1. **Модели данных**:
   - `OrderItem` - Элемент заказа
   - `OrderCreate` - Модель для создания заказа
   - `Order` - Заказ пользователя

2. **Хранилище данных**:
   - In-memory словарь `orders_db` для хранения заказов

3. **Фоновые задачи**:
   - `process_order` - Автоматическое изменение статуса заказа с течением времени
   - `notify_user_service` - Уведомление сервиса пользователей об изменениях в заказе

### Основные эндпоинты

- `GET /order-api/orders/` - Получение списка заказов пользователя или всех заказов для админа
- `POST /order-api/orders/` - Создание нового заказа
- `GET /order-api/orders/{order_id}` - Получение информации о конкретном заказе
- `PUT /order-api/orders/{order_id}/status` - Обновление статуса заказа (только для администраторов)
- `PUT /order-api/orders/{order_id}/cancel` - Отмена заказа
- `GET /order-api/orders/statuses/list` - Получение списка возможных статусов заказа

### Зависимости

- `fastapi` - Веб-фреймворк для создания API
- `uvicorn` - ASGI-сервер для запуска FastAPI
- `httpx` - HTTP-клиент для асинхронных запросов
- `pydantic` - Валидация данных
- `asyncio` - Асинхронное программирование

### Взаимодействие с другими сервисами

- **Backend Service** - Получение информации о товарах
- **User Service** - Отправка уведомлений об изменениях в заказе
- **Cart Service** - Получение данных корзины для создания заказа

## Nginx

Веб-сервер, выполняющий роль обратного прокси для всех сервисов.

### Технические характеристики

- **Версия**: nginx:latest
- **Порт**: 80
- **Контейнер**: app/nginx/Dockerfile

### Основные функции

1. **Маршрутизация запросов** к соответствующим сервисам:
   - `/api/*` → Backend Service
   - `/cart-api/*` → Cart Service
   - `/order-api/*` → Order Service
   - `/user-api/*` → User Service
   - `/docs/*` → Documentation Service

2. **Балансировка нагрузки** (в будущем, при масштабировании сервисов)

3. **Терминация SSL** (в будущем, для защиты соединения)

### Конфигурация

```nginx
server {
    listen 80;
    server_name localhost;

    # Проксирование запросов к API
    location /api/ {
        proxy_pass http://backend:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Проксирование запросов к сервису корзины
    location /cart-api/ {
        proxy_pass http://cart-service:8001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Проксирование запросов к сервису заказов
    location /order-api/ {
        proxy_pass http://order-service:8002/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Проксирование запросов к сервису пользователей
    location /user-api/ {
        proxy_pass http://user-service:8003/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Проксирование запросов к документации
    location /docs/ {
        proxy_pass http://docs:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Корневой маршрут - перенаправление на документацию
    location = / {
        return 302 /docs/;
    }
}
```

## Documentation Service

Сервис для предоставления документации проекта.

### Технические характеристики

- **Инструмент**: MkDocs с темой Material
- **Порт**: 8000
- **Контейнер**: app/docs/Dockerfile

### Основные разделы документации

1. **Главная страница** - Общая информация о проекте
2. **Архитектура** - Описание архитектуры проекта и взаимодействия сервисов
3. **API** - Документация по API всех сервисов
4. **База данных** - Описание схемы базы данных и запросов
5. **Воспроизведение алертов** - Инструкции по воспроизведению алертов
6. **План работ** - План дальнейшего развития проекта

## Общие принципы взаимодействия

### Аутентификация и авторизация

1. **Пользователь** регистрируется или входит в систему через **User Service**.
2. **User Service** генерирует JWT-токен и возвращает его пользователю.
3. **Пользователь** использует токен для аутентификации во всех запросах.
4. **Nginx** передает заголовок `Authorization` в соответствующий сервис.
5. **Сервисы** проверяют токен или используют заголовок `X-User-ID` для идентификации пользователя.

### Создание заказа

1. **Пользователь** добавляет товары в корзину через **Cart Service**.
2. **Cart Service** проверяет наличие товаров через **Backend Service**.
3. **Пользователь** оформляет заказ через **User Service**.
4. **User Service** запрашивает создание заказа у **Cart Service**.
5. **Cart Service** создает заказ через **Order Service** и очищает корзину.
6. **Order Service** запускает фоновую задачу для обработки заказа и уведомляет **User Service** об изменениях статуса.

## Масштабирование и отказоустойчивость

Для обеспечения масштабируемости и отказоустойчивости системы рекомендуется:

1. **Горизонтальное масштабирование** сервисов путем запуска нескольких экземпляров.
2. **Использование балансировщика нагрузки** (например, Nginx) для распределения запросов между экземплярами.
3. **Внедрение Circuit Breaker** для предотвращения каскадных отказов.
4. **Реализация retry-механизмов** для обработки временных сбоев.
5. **Мониторинг и алертинг** для оперативного реагирования на проблемы.

## Мониторинг и логирование

Для эффективного мониторинга системы рекомендуется:

1. **Сбор метрик** с помощью Prometheus:
   - Latency API-запросов
   - RPS (Requests Per Second)
   - Ошибки
   - Использование ресурсов (CPU, память)

2. **Визуализация метрик** с помощью Grafana:
   - Дашборды для каждого сервиса
   - Общий дашборд состояния системы

3. **Трейсинг запросов** с помощью Jaeger или Zipkin:
   - Отслеживание запросов между сервисами
   - Анализ производительности

4. **Централизованное логирование** с помощью ELK-стека:
   - Сбор логов со всех сервисов
   - Поиск и анализ логов 