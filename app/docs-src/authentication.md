# Аутентификация и взаимодействие между сервисами

В нашей микросервисной архитектуре реализована надежная система аутентификации и авторизации, обеспечивающая безопасное взаимодействие как между пользователем и сервисами, так и между самими сервисами.

## JWT-аутентификация

Основной механизм аутентификации в системе - JSON Web Tokens (JWT). Этот подход имеет следующие преимущества:

1. **Безопасность**: Токены подписываются секретным ключом, что гарантирует их подлинность
2. **Отсутствие состояния**: Серверу не нужно хранить сессии пользователей
3. **Масштабируемость**: Подходит для микросервисной архитектуры
4. **Передача данных**: Токен содержит информацию о пользователе (username)

## Процесс аутентификации

1. **Регистрация пользователя**:
   - Пользователь регистрируется через User Service
   - Пароль хешируется и сохраняется в базе данных
   - Возвращается информация о созданном пользователе

2. **Получение токена**:
   - Пользователь отправляет логин и пароль на эндпоинт `/user-api/token`
   - User Service проверяет учетные данные
   - При успешной аутентификации генерируется JWT токен с именем пользователя в поле "sub"
   - Токен возвращается клиенту

3. **Использование токена**:
   - Клиент включает токен в заголовок `Authorization` при каждом запросе
   - Формат: `Authorization: Bearer <jwt_token>`
   - Сервисы проверяют токен и извлекают имя пользователя для идентификации

## Межсервисное взаимодействие

Для обеспечения безопасного взаимодействия между микросервисами реализованы следующие механизмы:

### 1. Передача JWT токена

При взаимодействии между сервисами JWT токен передается в заголовке `Authorization`. Например, когда Cart Service вызывает Order Service для создания заказа:

```python
# Пример из Cart Service
headers = {}
if authorization:  # Если токен был получен от клиента
    headers["Authorization"] = authorization

# Вызов Order Service с передачей токена
async with httpx.AsyncClient() as client:
    response = await client.post(
        f"{ORDER_SERVICE_URL}/orders/",
        json=order_data,
        headers=headers
    )
```

### 2. Использование заголовка X-User-ID

Для обеспечения совместимости и дополнительной идентификации используется заголовок `X-User-ID`, который содержит имя пользователя:

```python
# Пример из Cart Service
headers = {
    "X-User-ID": user_id
}
if authorization:
    headers["Authorization"] = authorization

# Вызов Order Service с передачей обоих заголовков
```

### 3. Извлечение пользователя из токена

Order Service может извлекать имя пользователя из JWT токена:

```python
# Пример из Order Service
def get_user_id(
    authorization: Optional[str] = Header(None),
    x_user_id: Optional[str] = Header(None, alias="X-User-ID")
):
    if x_user_id:
        return x_user_id
    
    if authorization and authorization.startswith("Bearer "):
        token = authorization.replace("Bearer ", "")
        try:
            payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
            username = payload.get("sub")
            if username:
                return username
        except Exception:
            pass
    
    raise HTTPException(status_code=401, detail="Invalid authentication credentials")
```

## Обработка ошибок аутентификации

Система обрабатывает различные сценарии ошибок аутентификации:

1. **Отсутствие токена**: Возвращается ошибка 401 Unauthorized
2. **Недействительный токен**: Возвращается ошибка 401 Unauthorized с деталями
3. **Истекший токен**: Пользователю необходимо получить новый токен
4. **Недостаточные права**: Возвращается ошибка 403 Forbidden

## Рекомендации по безопасности

1. **Защита секретного ключа**: Секретный ключ для подписи JWT должен храниться в безопасном месте
2. **Короткий срок действия токенов**: Рекомендуется устанавливать небольшой срок действия токенов
3. **HTTPS**: Все взаимодействия должны происходить по защищенному протоколу HTTPS
4. **Валидация данных**: Все входные данные должны проходить валидацию

## Тестирование аутентификации

Для тестирования механизма аутентификации можно использовать скрипт `test_all_microservices.sh`, который демонстрирует полный процесс регистрации, получения токена и его использования для доступа к защищенным ресурсам. 