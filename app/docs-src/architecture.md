# Архитектура проекта

Система построена на микросервисной архитектуре и полностью контейнеризирована с помощью Docker. Оркестрация для локальной разработки осуществляется через Docker Compose.

## Схема взаимодействия сервисов

![1753046279366](image/architecture/1753046279366.png)

## Компоненты системы

### Backend (FastAPI)

Основной сервис, реализующий бизнес-логику и предоставляющий REST API для работы с товарами. Написан на Python с использованием фреймворка FastAPI.

Ключевые особенности:
- Асинхронная обработка запросов
- Автоматическая валидация данных с помощью Pydantic
- Автоматическая генерация OpenAPI-документации (Swagger)
- Интеграция с базой данных Cassandra

### User Service (Сервис пользователей)

Микросервис для управления пользователями. Позволяет регистрировать новых пользователей, аутентифицировать их, хранить и обновлять их профили.

Ключевые особенности:
- Регистрация и аутентификация пользователей через JWT токены
- Хранение профилей пользователей
- Отслеживание истории заказов пользователей
- Подсчет общей суммы потраченных средств
- Интеграция с сервисами корзины и заказов через HTTP клиент HTTPX
- Передача аутентификационных заголовков при межсервисном взаимодействии
- Поддержка как заголовка Authorization, так и X-User-ID для идентификации пользователя

### Cart Service (Сервис корзины)

Микросервис для управления корзиной пользователя. Позволяет добавлять товары в корзину, изменять их количество, просматривать содержимое корзины и оформлять заказ.

Ключевые особенности:
- Хранение корзин пользователей в памяти
- Взаимодействие с основным API для проверки наличия товаров
- Взаимодействие с сервисом заказов для оформления заказа
- Передача JWT токена при взаимодействии с сервисом заказов
- Поддержка как заголовка Authorization, так и X-User-ID для идентификации пользователя
- Использование фоновых задач для асинхронной обработки операций

### Order Service (Сервис заказов)

Микросервис для управления заказами пользователей. Позволяет создавать заказы, отслеживать их статус, отменять заказы и просматривать историю заказов.

Ключевые особенности:
- Автоматическое изменение статуса заказа с течением времени
- Случайное время доставки (от 1 до 5 минут в демо-режиме)
- Возможность отмены заказа пользователем
- Автоматическое удаление доставленных заказов через некоторое время
- Интеграция с сервисом пользователей для уведомлений о статусе заказа
- Поддержка JWT аутентификации и извлечение username из токена
- Поддержка как заголовка Authorization, так и X-User-ID для идентификации пользователя

### База данных (Cassandra)

Распределенная NoSQL база данных, используемая для хранения информации о товарах.

Схема данных:
- **Keyspace**: store
- **Таблицы**:
  - `products`: хранение информации о товарах (id, name, category, price, quantity)

### Nginx

Веб-сервер, выполняющий роль обратного прокси. Перенаправляет запросы к соответствующим сервисам:
- `/api/*` → Backend
- `/cart-api/*` → Cart Service
- `/order-api/*` → Order Service
- `/user-api/*` → User Service
- `/docs/*` → Documentation

Ключевые особенности:
- Передача заголовков аутентификации между клиентом и сервисами
- Передача заголовков X-Forwarded-For и X-Forwarded-Proto для правильной обработки запросов
- Настройка таймаутов для обеспечения стабильной работы при высокой нагрузке

### Documentation (MkDocs)

Сервис, предоставляющий документацию проекта в удобном для чтения формате.

## Модель данных

### Product (Товар)

```python
class Product:
    id: UUID            # Уникальный идентификатор товара
    name: str           # Название товара
    category: str       # Категория товара
    price: Decimal      # Цена товара
    quantity: int       # Количество товара на складе
```

### CartItem (Элемент корзины)

```python
class CartItem:
    id: UUID            # Уникальный идентификатор элемента корзины
    product_id: UUID    # Идентификатор товара
    quantity: int       # Количество товара в корзине
    price: float        # Цена товара
    product_name: str   # Название товара
```

### Cart (Корзина)

```python
class Cart:
    id: UUID            # Уникальный идентификатор корзины
    user_id: str        # Идентификатор пользователя
    items: List[CartItem] # Список товаров в корзине
    total_price: float  # Общая стоимость корзины
```

### OrderItem (Элемент заказа)

```python
class OrderItem:
    product_id: str     # Идентификатор товара
    quantity: int       # Количество товара
    price: float        # Цена товара
    product_name: str   # Название товара
```

### Order (Заказ)

```python
class Order:
    id: UUID            # Уникальный идентификатор заказа
    user_id: str        # Идентификатор пользователя (username)
    items: List[OrderItem] # Список товаров в заказе
    total_price: float  # Общая стоимость заказа
    status: str         # Статус заказа (new, processing, preparing, shipping, delivered, cancelled)
    created_at: datetime # Дата и время создания заказа
    updated_at: Optional[datetime] # Дата и время последнего обновления заказа
    estimated_delivery: Optional[datetime] # Ожидаемое время доставки
```

### User (Пользователь)

```python
class User:
    id: UUID            # Уникальный идентификатор пользователя
    username: str       # Имя пользователя (логин)
    full_name: str      # Полное имя пользователя
    phone: str          # Номер телефона пользователя
    created_at: datetime # Дата и время регистрации
    total_spent: float  # Общая сумма потраченных средств
```

### UserProfile (Профиль пользователя)

```python
class UserProfile(User):
    orders: List[OrderSummary] # Список заказов пользователя
    current_cart_total: float  # Общая стоимость текущей корзины
```

## Схема взаимодействия микросервисов

1. **User Service** → **Cart Service**: Получение корзины пользователя (передача JWT токена)
2. **User Service** → **Order Service**: Получение списка заказов пользователя (передача JWT токена и X-User-ID)
3. **Cart Service** → **Backend**: Проверка наличия товаров
4. **Cart Service** → **Order Service**: Создание заказа (передача JWT токена и X-User-ID)
5. **Order Service** → **User Service**: Уведомление об изменении статуса заказа

## Аутентификация и авторизация

Система использует JWT (JSON Web Tokens) для аутентификации и авторизации пользователей:

1. Пользователь регистрируется или входит в систему через User Service
2. User Service генерирует JWT токен с именем пользователя в поле "sub"
3. Клиент использует этот токен в заголовке Authorization при запросах к API
4. Сервисы проверяют токен и извлекают имя пользователя для идентификации
5. При межсервисном взаимодействии токен передается в заголовке Authorization
6. Для обеспечения совместимости также используется заголовок X-User-ID с именем пользователя

Такой подход обеспечивает безопасное взаимодействие между сервисами и гарантирует, что пользователь имеет доступ только к своим данным.